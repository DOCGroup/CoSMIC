<?xml version='1.0' encoding='utf-8' ?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
  <!-- This file is handcrafted since there is now way to generate 
       such a file using MPC. Towards the bottom of this file, it 
       includes the .wxi files that are generated by the Wix project
       in MPC.
    -->
  <Product Name='CoSMIC Modeling Tool Suite' Id='A91C0917-9925-4B7E-AA7E-4FCD294CC5EC'
           Language='1033' Codepage='1252'
           Version='0.7.8'
           Manufacturer='DOC Group / Institute for Software Integrated Systems (ISIS)'
           UpgradeCode='42C014ED-7C97-4107-94CD-2028CDBA3FD1'>

    <Package Keywords='Installer'
             Description="Component Synthesis with Model Integrated Computing (CoSMIC)"
             Manufacturer='DOC Group / Institute for Software Integrated Systems (ISIS)'
             InstallerVersion='300' Languages='1033' Compressed='yes' 
             SummaryCodepage='1252' />

    <!-- Wix variables -->
    <WixVariable Id="WixUILicenseRtf" Value="$(env.COSMIC_ROOT)/License.rtf" />

    <Condition Message='CoSMIC is not suported on Windows 95/98/ME.'>
      NOT Version9X
    </Condition>
    <Condition Message="You need to be an administrator to install this product.">
      Privileged
    </Condition>

<?if $(var.GME_VERSION) = 10.2.9 ?>
    <Condition Message="This version of CoSMIC requires GME 10.2.9. Please install GME 10.2.9 first.">
      GMEINSTALLED
    </Condition>
<?endif ?>

    <!-- installation media -->
    <Media Id="1" Cabinet="CoSMIC_MSI.cab" EmbedCab="yes" />

    <!-- check if GME is installed -->
    <Property Id="GMEINSTALLED">
      <RegistrySearch Id="GMEInstalledRegSearch"
                      Root="HKLM" Key="SOFTWARE\GME\Paradigms\MetaGME"
                      Name="CurrentVersion" Type="raw" />
    </Property>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id="SystemFolder" />

      <!-- Files related to the Program Files directory -->
      <Directory Id="ProgramFilesFolder" Name="Program Files">
        <Directory Id="ISIS" Name="ISIS">
          <Directory Id ="INSTALLDIR" Name="CoSMIC">
            <Component Id='COSMIC_ROOT' Guid='C4DA0B16-D93C-407A-AFFD-E4C918C2884D'>
              <RegistryKey Root='HKLM' Key='SOFTWARE\ISIS' Action="create"/>
              <RegistryValue Id='CoSMICTargetDir' Root='HKLM' 
                             Key='SOFTWARE\ISIS\CoSMIC' Name='TargetDir' 
                             Action='write' Type='string' Value='[INSTALLDIR]' />

              <Environment Id='env.PATH' Name='PATH' System='yes' Part='last' 
                           Value='[INSTALLDIR]bin' Action='set' />
              
              <Environment Id='env.COSMIC_ROOT' Name='COSMIC_ROOT' Action='create' 
                           System='yes' Value='[INSTALLDIR]' Permanent='no' />
            </Component>
          </Directory>
        </Directory>
      </Directory>

      <!-- Files related to the All Programs menu -->
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuFolder.CoSMIC" Name='CoSMIC' >
          <Component Id="NotesShortcutComponent" Guid="4A277173-A911-4F1F-B506-993573708189">
            <RemoveFolder Id="CleanupShortcutNotesFolder" On="uninstall" />

            <RegistryKey Root="HKCU" Key="SOFTWARE\ISIS\CoSMIC" Action="createAndRemoveOnUninstall">
              <RegistryValue Name="INSTALLDIR" Value="[INSTALLDIR]" Type="string" KeyPath="yes"/>
            </RegistryKey>
          </Component>

          <Component Id="Uninstaller" Guid="C981D60E-18DF-4F53-B6D3-2160B5B1A68B" >
            <RegistryKey Root="HKCU" Key="SOFTWARE\ISIS\CoSMIC" Action="createAndRemoveOnUninstall">
              <RegistryValue Name="Uninstaller" Value="msiexec.exe /x {product GUID}" Type="string" KeyPath="yes" />
            </RegistryKey>
            
            <Shortcut Id="CoSMICUninstallShortCut" Directory="ProgramMenuFolder.CoSMIC"
                      Name="Uninstall CoSMIC" WorkingDirectory='SystemDir'
                      Target="[UNINSTALLCMD]"
                      Arguments="/x {A91C0917-9925-4B7E-AA7E-4FCD294CC5EC}"
                      Description="Uninstaller for CoSMIC" />
          </Component>

          <Directory Id="ProgramMenuFolder.CoSMIC.Docs" Name="Documentation">
            <Component Id="DocsShortcutComponent" Guid="D9B0D77F-C3EF-4AAA-97F4-D248A8068551">
              <RemoveFolder Id="CleanupShortcutDocsFolder" On="uninstall" />

              <RegistryKey Root="HKCU" Key="SOFTWARE\ISIS\CoSMIC" Action="createAndRemoveOnUninstall">
                <RegistryValue Name="DOCSDIR" Value="[INSTALLDIR]docs" Type="string" KeyPath="yes"/>
              </RegistryKey>
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <ComponentGroup Id="CoSMIC_MAIN" >
      <ComponentRef Id="COSMIC_ROOT"  />
      
      <ComponentRef Id="Uninstaller" />
      <ComponentRef Id="NotesShortcutComponent"/>
      <ComponentRef Id="DocsShortcutComponent" />

      <ComponentGroupRef Id="CoSMIC_Release_Build" />
    </ComponentGroup>
    
    <!-- product features -->
    <Feature Id="CoSMIC_MSI_feature" Title="CoSMIC Tool Suite for GME"
             Display="collapse" Absent="disallow"
             Description="Installs the default CoSMIC tool suite for GME"
             Level="1" ConfigurableDirectory="INSTALLDIR"
             AllowAdvertise="no">
      
      <!-- main component -->
      <ComponentGroupRef Id="CoSMIC_MAIN" Primary="yes" />

      <!-- gather all the third-party components -->
      <ComponentRef Id="xerces" />
      <ComponentRef Id="UDM" />
      <ComponentRef Id="zlib" />

      <!-- include the VC merge modules -->
      <FeatureRef Id="vc_merge_modules" />
    </Feature>

    <!-- user interface -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <UIRef Id="WixUI_Mondo" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <InstallExecuteSequence>
      <Custom Action='SetGMEVersion' After='InstallInitialize'>NOT Installed</Custom>
      <Custom Action='GMEVersion' After='SetGMEVersion'>NOT Installed</Custom>

      <Custom Action="SetUninstallCmd" Before="FindRelatedProducts" />
    </InstallExecuteSequence>

  </Product>

  <!-- include the main file that contains all the projects -->
  <?include CoSMIC_Release_Build.wxi ?>

  <!-- third-party library includes -->
  <?include includes\xerces.wxi ?>
  <?include includes\udm.wxi ?>
  <?include includes\zlib.wxi ?>
</Wix>
